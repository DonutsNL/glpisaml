<!-- implemented in ConfigForm->generateForm() -->
<!-- https://codeberg.org/QuinQuies/glpisaml/issues/13 -->
{% import glpi_tpl_macro as fields %}

<script>
    // Remember tab state
    $(function() {
        $('a[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
            localStorage.setItem('lastTab', $(this).attr('href'));
        });
        var lastTab = localStorage.getItem('lastTab');
        
        if (lastTab) {
            $('[href="' + lastTab + '"]').tab('show');
        }
    });
    // Clipboard function
    function copyClip(key) {
        // Get the text field
        var copyText = document.getElementById(key);
        // Select the text field
        copyText.select();
        copyText.setSelectionRange(0, 99999); // For mobile devices
        // Copy the text inside the text field
        navigator.clipboard.writeText(copyText.value);
        // Alert the copied text
        alert("Succesfully copied the value: " + copyText.value + " to your clipboard.");
    }
</script>

<form name="form" method="post" action="{{ glpi_rootdoc }}" id="phpsaml_config">
<div class="phpsaml_config_wrapper" id="samlForm">
    <input type="hidden" name="{{ inputfields.id.field }}" value="{{ inputfields.id.value }}">

    <div class="card" style="min-height:100%;">
        <!-- Input fields -->
        <ul class="nav nav-tabs" id="samlTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link active" 
                   id="general-tab" 
                   data-bs-toggle="tab" 
                   href="#general" 
                   data-bs-target="#general" 
                   type="button" role="tab" 
                   aria-controls="general" 
                   aria-selected="true"><b>{{ __("General") }} {{ general_warning }}</b></a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" 
                   id="general-tab" 
                   data-bs-toggle="tab" 
                   href="#transit" 
                   data-bs-target="#transit" 
                   type="button" 
                   role="tab" 
                   aria-controls="transit" 
                   aria-selected="true"><b>{{ __('Transit', plugin) }} {{ header_warning }}</b></a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" 
                   id="provider-tab" 
                   data-bs-toggle="tab" 
                   href="#provider" 
                   data-bs-target="#provider" 
                   type="button" 
                   role="tab" 
                   aria-controls="provider" 
                   aria-selected="false"><b>{{ __('Service provider', plugin) }} {{ provider_warning }}</b></a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" 
                   id="idp-tab" 
                   data-bs-toggle="tab" 
                   href="#idp" 
                   data-bs-target="#idp" 
                   type="button" 
                   role="tab" 
                   aria-controls="idp" 
                   aria-selected="false"><b>{{ __('Identity provider', plugin) }} {{ idp_warning }}</b></a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" 
                   id="security-tab" 
                   data-bs-toggle="tab" 
                   href="#security" 
                   data-bs-target="#security" 
                   type="button" 
                   role="tab" 
                   aria-controls="security" 
                   aria-selected="false"><b>{{ __('Security') }} {{ security_warning }}</b></a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" 
                   id="logging-tab" 
                   data-bs-toggle="tab" 
                   href="#logging" 
                   data-bs-target="#logging" 
                   type="button" 
                   role="tab" 
                   aria-controls="logging" 
                   aria-selected="false"><b>{{ __('Log') }} {{ logging_warning }}</b></a>
            </li>
        </ul>
        <div class="tab-content flex-fill glpisaml" id="myTabContent">
            <!-- ################################################################################-->
            <!-- General details -->
            <div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
                <div class="card-body">
                    <div class="row g-2">
                        <!-- name field -->
                        <div>
                            {% set helper %}
                                <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                                data-bs-content="{{ inputfields.name.formexplain }}">?</span>
                            {% endset %}
                            {% set error_helper %}
                                {% if inputfields.name.errors == true %}
                                    <div id="textHelper" class="form-text" style="color:red;">{{ inputfields.name.errors }}</div>
                                {% endif %}
                                {% if buttonsHiddenWarn == true %}
                                    <div id="textHelper" class="form-text" style="color:rgb(180, 120, 8)">‚ö†Ô∏è Userdomain is configured. The login button will be hidden from the loginscreen. Clear the Userdomain to make the button visable again.</div>
                                {% endif %}
                            {% endset %}

                            {{ fields.textField(
                                inputfields.name.field, 
                                inputfields.name.value, 
                                inputfields.name.formtitle ~ helper, 
                                {
                                    'add_field_html': error_helper,
                                }
                            ) }}
                        </div>
                   
                        <!-- icon field -->
                        <div>
                            {% set helper %}
                                <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                                data-bs-content="{{ inputfields.conf_icon.formexplain }}">?</span>
                            {% endset %}
                            {% set error_helper %}
                                {% if inputfields.conf_icon.errors == true %}
                                    <div id="textHelper" class="form-text" style="color:red;">{{ inputfields.conf_icon.errors }}</div>
                                {% endif %}
                                {% if buttonsHiddenWarn == true %}
                                    <div id="textHelper" class="form-text" style="color:rgb(180, 120, 8)">‚ö†Ô∏è Userdomain is configured. The login button will be hidden from the loginscreen. Clear the Userdomain to make the button visable again.</div>
                                {% endif %}
                            {% endset %}
                            {{ fields.textField(
                                inputfields.conf_icon.field, 
                                inputfields.conf_icon.value, 
                                inputfields.conf_icon.formtitle ~ helper, 
                                {
                                    'add_field_html': error_helper,
                                }
                            ) }}
                        </div>

                        <!-- domain field -->
                        <div>
                            {% set helper %}
                                <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                                data-bs-content="{{ inputfields.conf_domain.formexplain }}">?</span>
                            {% endset %}
                            {% set error_helper %}
                                {% if inputfields.conf_domain.errors == true %}
                                    <div id="textHelper" class="form-text" style="color:red;">{{ inputfields.conf_domain.errors }}</div>
                                {% endif %}
                                {% if buttonsHiddenWarn == true %}
                                    <div id="textHelper" class="form-text" style="color:rgb(3, 126, 26)">üîí Userdomain is configured. Users can trigger a Saml Login by providing their {username}@{userdomain} in the glpi username
                                                                                                           field and pressing the login button. The password field is ignored and can be left blank. This is a more secure option that
                                                                                                           wont expose configured IDPs.
                                    </div>
                                {% endif %}
                            {% endset %}

                            {{ fields.textField(
                                inputfields.conf_domain.field, 
                                inputfields.conf_domain.value, 
                                inputfields.conf_domain.formtitle ~ helper, 
                                {
                                    'add_field_html': error_helper,
                                }
                            ) }}
                        </div>

                        <!-- Comment field -->
                        <div>
                            {% set helper %}
                                <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                                data-bs-content="{{ inputfields.comment.formexplain }}">?</span>
                            {% endset %}
                            {% set error_helper %}
                                {% if inputfields.comment.errors == true %}
                                    <div id="textHelper" class="form-text" style="color:red;">{{ inputfields.comment.errors }}</div>
                                {% endif %}
                            {% endset %}
                            {{ fields.textareaField(
                                inputfields.comment.field, 
                                inputfields.comment.value, 
                                inputfields.comment.formtitle ~ helper, 
                                {
                                    'required':false,
                                    'add_field_html': error_helper,
                                }
                            ) }}
                        </div>

                         <!-- enabled -->
                         <div>
                            {% set helper %}
                                <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                                data-bs-content="{{ inputfields.is_active.formexplain }}">?</span>
                            {% endset %}
                            {% set error_helper %}
                                {% if inputfields.is_active.errors == true %}
                                    <div id="textHelper" class="form-text" style="color:red;">{{ inputfields.is_active.errors }}</div>
                                {% endif %}
                            {% endset %}
                            {{ fields.sliderField(
                                inputfields.is_active.field,
                                inputfields.is_active.value,
                                inputfields.is_active.formtitle ~ helper,
                               {
                                  'add_field_html': error_helper,
                               }
                            ) }}
                        </div>

                        <!-- Debug mode -->
                        <div>
                            {% set helper %}
                                <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                                data-bs-content="{{ inputfields.debug.formexplain }}">?</span>
                            {% endset %}
                            {% set error_helper %}
                                {% if inputfields.debug.errors == true %}
                                    <div id="textHelper" class="form-text" style="color:red;">{{ inputfields.debug.errors }}</div>
                                {% endif %}
                            {% endset %}
                            {{ fields.sliderField(
                                inputfields.debug.field,
                                inputfields.debug.value,
                                inputfields.debug.formtitle ~ helper,
                               {
                                  'add_field_html': error_helper,
                               }
                            ) }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- ################################################################################-->
            <!-- transit tab -->
            <div class="tab-pane fade show" id="transit" role="tabpanel" aria-labelledby="transit-tab">
                <div class="card-body">
                    <div class="row g-2">

                        <!-- compress_requests -->
                        <div>
                            {% set helper %}
                                <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                                data-bs-content="{{ inputfields.compress_requests.formexplain }}">?</span>
                            {% endset %}
                            {% set error_helper %}
                                {% if inputfields.compress_requests.errors == true %}
                                    <div id="textHelper" class="form-text" style="color:red;">{{ inputfields.compress_requests.errors }}</div>
                                {% endif %}
                            {% endset %}
                            {{ fields.sliderField(
                                inputfields.compress_requests.field,
                                inputfields.compress_requests.value,
                                inputfields.compress_requests.formtitle ~ helper,
                               {
                                  'add_field_html': error_helper,
                               }
                            ) }}
                        </div>

                        <!-- compress_responses -->
                        <div>
                            {% set helper %}
                                <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                                data-bs-content="{{ inputfields.compress_responses.formexplain }}">?</span>
                            {% endset %}
                            {% set error_helper %}
                                {% if inputfields.compress_responses.errors == true %}
                                    <div id="textHelper" class="form-text" style="color:red;">{{ inputfields.compress_responses.errors }}</div>
                                {% endif %}
                            {% endset %}
                            {{ fields.sliderField(
                                inputfields.compress_responses.field,
                                inputfields.compress_responses.value,
                                inputfields.compress_responses.formtitle ~ helper,
                               {
                                  'add_field_html': error_helper,
                               }
                            ) }}
                        </div>
                        
                        <!-- Proxied -->
                        <div>
                            {% set helper %}
                                <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                                data-bs-content="{{ inputfields.proxied.formexplain }}">?</span>
                            {% endset %}
                            {% set error_helper %}
                                {% if inputfields.proxied.errors == true %}
                                    <div id="textHelper" class="form-text" style="color:red;">{{ inputfields.proxied.errors }}</div>
                                {% endif %}
                                {% if inputfields.proxied.value == true %}
                                    {% if inputfields.strict.value == true %}
                                        <div id="textHelper" class="form-text" style="color:rgb(180, 120, 8);">‚ö†Ô∏è Make sure the proxy scheme matches the server scheme.<br>(<b>https</b>://external)=>(<b>https</b>://internal)</div>
                                    {% endif %}
                                {% endif %}
                            {% endset %}
                            {{ fields.sliderField(
                                inputfields.proxied.field,
                                inputfields.proxied.value,
                                inputfields.proxied.formtitle ~ helper,
                               {
                                  'add_field_html': error_helper,
                               }
                            ) }}
                        </div>

                        <!-- validate_xml -->
                        <div>
                            {% set helper %}
                                <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                                data-bs-content="{{ inputfields.validate_xml.formexplain }}">?</span>
                            {% endset %}
                            {% set error_helper %}
                                {% if inputfields.validate_xml.errors == true %}
                                    <div id="textHelper" class="form-text" style="color:red;">{{ inputfields.validate_xml.errors }}</div>
                                {% endif %}
                                {% if inputfields.strict.value == false %}
                                    <div id="textHelper" class="form-text" style="color:rgb(180, 120, 8);">‚ö†Ô∏è Strict is disabled, validate xml setting will not do anything.</div>
                                {% endif %}
                            {% endset %}
                            {{ fields.sliderField(
                                inputfields.validate_xml.field,
                                inputfields.validate_xml.value,
                                inputfields.validate_xml.formtitle ~ helper,
                               {
                                  'add_field_html': error_helper,
                               }
                            ) }}
                        </div>

                        <!-- validate_destination -->
                        <div>
                            {% set helper %}
                                <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                                data-bs-content="{{ inputfields.validate_destination.formexplain }}">?</span>
                            {% endset %}
                            {% set error_helper %}
                                {% if inputfields.validate_destination.errors == true %}
                                    <div id="textHelper" class="form-text" style="color:red;">{{ inputfields.validate_destination.errors }}</div>
                                {% endif %}
                            {% endset %}
                            {{ fields.sliderField(
                                inputfields.validate_destination.field,
                                inputfields.validate_destination.value,
                                inputfields.validate_destination.formtitle ~ helper,
                               {
                                  'add_field_html': error_helper,
                               }
                            ) }}
                        </div>

                        <!-- lowercase_url_encoding -->
                        <div>
                            {% set helper %}
                                <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                                data-bs-content="{{ inputfields.lowercase_url_encoding.formexplain }}">?</span>
                            {% endset %}
                            {% set error_helper %}
                                {% if inputfields.lowercase_url_encoding.errors == true %}
                                    <div id="textHelper" class="form-text" style="color:red;">{{ inputfields.lowercase_url_encoding.errors }}</div>
                                {% endif %}
                            {% endset %}
                            {{ fields.sliderField(
                                inputfields.lowercase_url_encoding.field,
                                inputfields.lowercase_url_encoding.value,
                                inputfields.lowercase_url_encoding.formtitle ~ helper,
                               {
                                  'add_field_html': error_helper,
                               }
                            ) }}
                        </div>

                    </div>
                </div>
            </div>

            <!-- ################################################################################-->
            <div class="tab-pane fade" id="provider" role="tabpanel" aria-labelledby="provider-tab">
                <div class="card-body">

                    <!-- Service provider details -->
                    <div>
                        <!-- Entity ID -->
                        {% set helper %}
                            <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                            data-bs-content="You need to configure the Entity ID at the identity provider. This value is
                                             crosschecked by the identity provider to make sure the sign-in request is
                                             originating from the correct service provider.">?</span>
                        {% endset %}
                        {% set clipboad %}
                            <span class='btn btn-ghost-info' onclick="copyClip('EntityId')" onkeydown="copyClip('EntityId')">Copy Entity Id to clipboard</span>
                        {% endset %}
                        {{ fields.textField(
                            'EntityID', 
                            entityID, 
                            'Entity ID' ~ helper,
                            {
                                'id': 'EntityId',
                                'disabled':true,
                                'add_field_html': clipboad,
                            }
                        ) }}

                        <!-- Meta URL -->
                        {% set helper %}
                            <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                            data-bs-content="The location of the metadata provider for this service provider (GLPI). The meta location can be
                                             used by the identity provider to collect important information from this service provider like
                                             what public certificate to use for signing and encrypting the SamlResponse.">?</span>
                        {% endset %}
                        {% set clipboad %}
                            <span class='btn btn-ghost-info' onclick="copyClip('MetaUrl')" onkeydown="copyClip('MetaUrl')">Copy Meta Url to clipboard</span>
                            {% if inputfields.debug.value == false %}
                                <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true" data-bs-content="Debug is 
                                disabled, metadata will only be exposed if 'debug' is enabled.">‚ö†Ô∏è</span>
                            {% endif %}
                        {% endset %}
                        {{ fields.textField(
                            'MetaUrl', 
                            metaUrl, 
                            'MetaUrl' ~ helper,
                            {
                                'id': 'MetaUrl',
                                'disabled':true,
                                'add_field_html': clipboad,
                            }
                        ) }}
                       
                        <!-- ACS url -->
                        {% set helper %}
                            <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                            data-bs-content="The location of the Assertion Consumer Service (ACS) for this service provider (GLPI). 
                                             This url is called by the identity provider after succesfull login.">?</span>
                        {% endset %}
                        {% set clipboad %}
                            <span class='btn btn-ghost-info' onclick="copyClip('AcsUrl')" onkeydown="copyClip('AcsUrl')">Copy ACS Url to clipboard</span>
                        {% endset %}
                        {{ fields.textField(
                            'AcsUrl', 
                            acsUrl, 
                            'AcsUrl' ~ helper,
                            {
                                'id': 'AcsUrl',
                                'disabled':true,
                                'add_field_html': clipboad,
                            }
                        ) }}
                    </div>

                    <!-- sp_certificate -->
                    <div>
                        {% set helper %}
                            <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                            data-bs-content="{{ inputfields.sp_certificate.formexplain }}">?</span>
                        {% endset %}
                        {% set error_helper %}
                            {% if inputfields.sp_private_key.errors == true %}
                                <div id="textHelper" class="form-text" style="color:red;">{{ inputfields.sp_private_key.errors }}</div>
                            {% endif %}
                            {% if inputfields.sp_certificate.errors == true %}
                                <div id="textHelper" class="form-text" style="color:red;">{{ inputfields.sp_certificate.errors }}</div>
                            {% endif %}
                            {% if inputfields.sp_certificate.validate.subject.CN == true %}
                                <div id="textHelper" class="form-text" style="color:rgb(71, 180, 8);">üÜó Valid certificate found: {{ inputfields.sp_certificate.validate.subject.CN }}</div>
                            {% endif %}
                            {% if inputfields.sp_certificate.validate.validations.validTo == true %}
                                <div id="textHelper" class="form-text" style="color:rgb(180, 120, 8);">{{ inputfields.sp_certificate.validate.validations.validTo }}</div>
                            {% endif %}
                            {% if inputfields.sp_certificate.validate.validations.validFrom == true %}
                                <div id="textHelper" class="form-text" style="color:rgb(180, 120, 8);">{{ inputfields.sp_certificate.validate.validations.validFrom }}</div>
                            {% endif %}
                        {% endset %}
                        
                        {{ fields.textareaField(
                            inputfields.sp_certificate.field,
                            inputfields.sp_certificate.value,
                            inputfields.sp_certificate.formtitle ~ helper,
                            {
                                'add_field_html': error_helper,
                            }) 
                        }}
                    </div>

                    <!-- sp_private_key -->
                    <div>
                        {% set helper %}
                            <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                            data-bs-content="{{ inputfields.sp_private_key.formexplain }}">?</span>
                        {% endset %}

                        {{ fields.textareaField( 
                            inputfields.sp_private_key.field,
                            inputfields.sp_private_key.value,
                            inputfields.sp_private_key.formtitle ~ helper,
                            {}) 
                        }}
                    </div>
                    
                    <div>
                        {% set helper %}
                            <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                            data-bs-content="{{ inputfields.sp_nameid_format.formexplain }}">?</span>
                        {% endset %}
                        {% set error_helper %}
                            {% if inputfields.sp_nameid_format.errors == true %}
                                <div id="textHelper" class="form-text" style="color:red;">{{ inputfields.sp_nameid_format.errors }}</div>
                            {% endif %}
                        {% endset %}

                        {{ fields.dropdownArrayField(
                            inputfields.sp_nameid_format.field,
                            inputfields.sp_nameid_format.value,
                            inputOptionsNameFormat,
                            inputfields.sp_nameid_format.formtitle ~ helper,
                            {
                                'add_field_html': error_helper,
                            }
                        ) }}
                    </div>


                </div>
            </div>

            <!-- ################################################################################-->
            <!-- Identity provider details -->
            <div class="tab-pane fade" id="idp" role="tabpanel" aria-labelledby="idp-tab">
                <div class="card-body">
                     <!-- idp_entity_id -->
                     <div>
                        {% set helper %}
                            <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                            data-bs-content="{{ inputfields.idp_entity_id.formexplain }}">?</span>
                        {% endset %}
                        {% set error_helper %}
                            {% if inputfields.idp_entity_id.errors == true %}
                                <div id="textHelper" class="form-text" style="color:red;">{{ inputfields.idp_entity_id.errors }}</div>
                            {% endif %}
                        {% endset %}

                        {{ fields.textField( 
                            inputfields.idp_entity_id.field, 
                            inputfields.idp_entity_id.value, 
                            inputfields.idp_entity_id.formtitle ~ helper, 
                            {
                                'add_field_html': error_helper,
                            }) 
                        }}
                    </div>

                    <!-- idp_single_sign_on_service -->
                    <div>
                        {% set helper %}
                            <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                            data-bs-content="{{ inputfields.idp_single_sign_on_service.formexplain }}">?</span>
                        {% endset %}
                        {% set error_helper %}
                            {% if inputfields.idp_single_sign_on_service.errors == true %}
                                <div id="textHelper" class="form-text" style="color:red;">{{ inputfields.idp_single_sign_on_service.errors }}</div>
                            {% endif %}
                        {% endset %}

                        {{ fields.textField( 
                            inputfields.idp_single_sign_on_service.field, 
                            inputfields.idp_single_sign_on_service.value, 
                            inputfields.idp_single_sign_on_service.formtitle ~ helper, 
                            {
                                'add_field_html': error_helper,
                            }) 
                        }}
                    </div>

                    <!-- idp_single_logout_service -->
                    <div>
                        {% set helper %}
                            <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                            data-bs-content="{{ inputfields.idp_single_logout_service.formexplain }}">?</span>
                        {% endset %}
                        {% set error_helper %}
                            {% if inputfields.idp_single_logout_service.errors == true %}
                                <div id="textHelper" class="form-text" style="color:red;">{{ inputfields.idp_single_logout_service.errors }}</div>
                            {% endif %}
                        {% endset %}

                        {{ fields.textField( 
                            inputfields.idp_single_logout_service.field, 
                            inputfields.idp_single_logout_service.value, 
                            inputfields.idp_single_logout_service.formtitle ~ helper, 
                            {
                                'add_field_html': error_helper,
                            }) 
                        }}
                    </div>

                    <!-- idp_certificate -->
                    <div>
                        {% set helper %}
                            <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                            data-bs-content="{{ inputfields.idp_certificate.formexplain }}">?</span>
                        {% endset %}
                        {% set error_helper %}
                            {% if inputfields.idp_certificate.errors == true %}
                                <div id="textHelper" class="form-text" style="color:red;">{{ inputfields.idp_certificate.errors }}</div>
                            {% endif %}
                            {% if inputfields.idp_certificate.validate.subject.CN == true %}
                                <div id="textHelper" class="form-text" style="color:rgb(71, 180, 8);">üÜó Valid Certificate found: {{ inputfields.idp_certificate.validate.subject.CN }}</div>
                            {% endif %}
                            {% if inputfields.idp_certificate.validate.validations.validTo == true %}
                                <div id="textHelper" class="form-text" style="color:rgb(180, 140, 8);">{{ inputfields.idp_certificate.validate.validations.validTo }}</div>
                            {% endif %}
                            {% if inputfields.idp_certificate.validate.validations.validFrom == true %}
                                <div id="textHelper" class="form-text" style="color:rgb(180, 140, 8);">{{ inputfields.idp_certificate.validate.validations.validFrom }}</div>
                            {% endif %}
                        {% endset %}

                        {{ fields.textareaField( 
                            inputfields.idp_certificate.field, 
                            inputfields.idp_certificate.value, 
                            inputfields.idp_certificate.formtitle ~ helper, 
                            {
                                'add_field_html': error_helper,
                            }) 
                        }}
                    </div>

                    <!-- requested_authn_context -->
                    <div>
                        <div class="form-field row col-12 col-sm-6  mb-2">
                            <div class="col-form-label col-xxl-5 text-xxl-end">
                                <label for="{{ inputfields.requested_authn_context.field }}">{{ inputfields.requested_authn_context.formtitle }}</label>
                                <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                            data-bs-content="{{ inputfields.requested_authn_context.formexplain }}">?</span>
                            </div>
                            <div class="col-xxl-7  field-container">
                                <!--
                                @see: https://codeberg.org/QuinQuies/glpisaml/issues/14
                                Todo: add nicer, userfriendly drag-drop element
                                -->
                                <select id="keep-order" multiple="multiple" aria-label="multiple select" name="{{ inputfields.requested_authn_context.field }}[]">
                                    {% for key, authn in inputOptionsAuthnContext %}
                                            {%set selected = false %}
                                            {% for value in inputfields.requested_authn_context.value %}
                                                {% if value == key %}
                                                    {% set selected = 'selected' %}
                                                {% endif %}
                                            {% endfor %}
                                                <option {{ selected }} value="{{ key }}">{{ authn }}</option>
                                        {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- requested_authn_context -->
                    <div>
                        {% set helper %}
                            <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                            data-bs-content="{{ inputfields.requested_authn_context_comparison.formexplain }}">?</span>
                        {% endset %}
                        {% set error_helper %}
                            {% if inputfields.requested_authn_context_comparison.errors == true %}
                                <div id="textHelper" class="form-text" style="color:red;">{{ inputfields.requested_authn_context_comparison.errors }}</div>
                            {% endif %}
                        {% endset %}

                        {{ fields.dropdownArrayField( 
                            inputfields.requested_authn_context_comparison.field,
                            inputfields.requested_authn_context_comparison.value,
                            inputOptionsAuthnCompare,
                            inputfields.requested_authn_context_comparison.formtitle ~ helper, 
                            {
                                'add_field_html': error_helper,
                            }) 
                        }}
                       
                    </div>

                </div>
            </div>

            <!-- ################################################################################-->
            <!-- Security details -->
            <div class="tab-pane fade" id="security" role="tabpanel" aria-labelledby="idp-tab">
                <div class="card-body">
                    <!-- enforce SSO -->
                    <div>
                        {% set helper %}
                            <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                            data-bs-content="{{ inputfields.enforce_sso.formexplain }}">?</span>
                        {% endset %}
                        {% set error_helper %}
                            {% if inputfields.enforce_sso.errors == true %}
                                <div id="textHelper" class="form-text" style="color:red;">{{ inputfields.enforce_sso.errors }}</div>
                            {% endif %}
                        {% endset %}
                        {{ fields.sliderField(
                            inputfields.enforce_sso.field,
                            inputfields.enforce_sso.value,
                            inputfields.enforce_sso.formtitle ~ helper,
                            {
                                'add_field_html': error_helper,
                            }
                        ) }}
                    </div>

                    <!-- Strict mode -->
                    <div>
                        {% set helper %}
                            <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                            data-bs-content="{{ inputfields.strict.formexplain }}">?</span>
                        {% endset %}
                        {% set error_helper %}
                            {% if inputfields.strict.errors == true %}
                                <div id="textHelper" class="form-text" style="color:red;">{{ inputfields.strict.errors }}</div>
                            {% endif %}
                            {% if inputfields.strict.value == false %}
                                        <div id="textHelper" class="form-text" style="color:rgb(180, 120, 8);">‚ö†Ô∏è Your environment is at risk, make sure strict is enabled!</div>
                            {% endif %}
                        {% endset %}
                        {{ fields.sliderField(
                            inputfields.strict.field,
                            inputfields.strict.value,
                            inputfields.strict.formtitle ~ helper,
                            {
                                'add_field_html': error_helper,
                            }
                        ) }}
                    </div>
                    
                    <!-- User JIT -->
                    <div>
                        {% set helper %}
                            <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                            data-bs-content="{{ inputfields.user_jit.formexplain }}">?</span>
                        {% endset %}
                        {% set error_helper %}
                            {% if inputfields.user_jit.errors == true %}
                                <div id="textHelper" class="form-text" style="color:red;">{{ inputfields.user_jit.errors }}</div>
                            {% endif %}
                        {% endset %}
                        {{ fields.sliderField(
                            inputfields.user_jit.field,
                            inputfields.user_jit.value,
                            inputfields.user_jit.formtitle ~ helper,
                            {
                                'add_field_html': error_helper,
                            }
                        ) }}
                    </div>
                    
                    <!-- security_nameidencrypted -->
                    <div>
                        {% set helper %}
                            <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                            data-bs-content="{{ inputfields.security_nameidencrypted.formexplain }}">?</span>
                        {% endset %}
                        {% set error_helper %}
                            {% if inputfields.security_nameidencrypted.errors == true %}
                                <div id="textHelper" class="form-text" style="color:red;">{{ inputfields.security_nameidencrypted.errors }}</div>
                            {% endif %}
                        {% endset %}
                        {{ fields.sliderField(
                            inputfields.security_nameidencrypted.field,
                            inputfields.security_nameidencrypted.value,
                            inputfields.security_nameidencrypted.formtitle ~ helper,
                            {
                                'add_field_html': error_helper,
                            }) 
                        }}
                    </div>

                    

                    <!-- security_authnrequestssigned -->
                    <div>
                        {% set helper %}
                            <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                            data-bs-content="{{ inputfields.security_authnrequestssigned.formexplain }}">?</span>
                        {% endset %}
                        {% set error_helper %}
                            {% if inputfields.security_authnrequestssigned.errors == true %}
                                <div id="textHelper" class="form-text" style="color:red;">{{ inputfields.security_authnrequestssigned.errors }}</div>
                            {% endif %}
                        {% endset %}
                        {{ fields.sliderField(
                            inputfields.security_authnrequestssigned.field,
                            inputfields.security_authnrequestssigned.value,
                            inputfields.security_authnrequestssigned.formtitle ~ helper,
                            {
                                'add_field_html': error_helper,
                            }) 
                        }}
                    </div>

                        

                    <!-- security_logoutrequestsigned -->
                    <div>
                        {% set helper %}
                            <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                            data-bs-content="{{ inputfields.security_logoutrequestsigned.formexplain }}">?</span>
                        {% endset %}
                        {% set error_helper %}
                            {% if inputfields.security_logoutrequestsigned.errors == true %}
                                <div id="textHelper" class="form-text" style="color:red;">{{ inputfields.security_logoutrequestsigned.errors }}</div>
                            {% endif %}
                        {% endset %}
                        {{ fields.sliderField(
                            inputfields.security_logoutrequestsigned.field,
                            inputfields.security_logoutrequestsigned.value,
                            inputfields.security_logoutrequestsigned.formtitle ~ helper,
                            {
                                'add_field_html': error_helper,
                            }) 
                        }}
                    </div>
    
                    

                    <!-- security_logoutresponsesigned -->
                    <div>
                        {% set helper %}
                            <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                            data-bs-content="{{ inputfields.security_logoutresponsesigned.formexplain }}">?</span>
                        {% endset %}
                        {% set error_helper %}
                            {% if inputfields.security_logoutresponsesigned.errors == true %}
                                <div id="textHelper" class="form-text" style="color:red;">{{ inputfields.security_logoutresponsesigned.errors }}</div>
                            {% endif %}
                        {% endset %}
                        {{ fields.sliderField(
                            inputfields.security_logoutresponsesigned.field,
                            inputfields.security_logoutresponsesigned.value,
                            inputfields.security_logoutresponsesigned.formtitle ~ helper,
                            {
                                'add_field_html': error_helper,
                            }) 
                        }}
                    </div>
                </div>
            </div>
            <!-- ################################################################################-->
            <!-- Security details -->
            <div class="tab-pane fade" id="logging" role="tabpanel" aria-labelledby="idp-tab">
                <div class="card-body">
                    <div class="row g-2">      
                        <!-- enforce SSO -->
                        <div class="col-md p-2">
                            <h2>Work in progress, logging is by no means complete but still usable. All feedback more than welcome!</h2>
                            <div>Phases: 1 = initial, 2=send_saml_SSO_request, 3=performed_saml_auth, 4=performed_glpi_auth, 5=file_exclude, 6=forced_logoff, 7=timed_out, 8=manual_glpi_logout
                            </div>
                            <table class="table table-striped table-sm">
                                <thead>
                                  <tr>
                                    <th>Id</th>
                                    <th>IdpId</th>
                                    <th>username</th>
                                    <th>glpiAuthed</th>
                                    <th>samlAuthed</th>
                                    <th>Phase</th>
                                    <th>loginTime</th>
                                    <th>lastClickTime</th>
                                    <th>Locations</th>
                                    <th>LoginFlowTrace</th>
                                  </tr>
                                </thead>
                                {% for logrow in loggingfields %}
                                <tr>
                                    <td>{{ logrow.id }}</td>
                                    <td>{{ logrow.idpId }}</td>
                                    <td>{{ logrow.userName }}</td>
                                    <td>{{ logrow.glpiAuthed }}</td>
                                    <td>{{ logrow.samlAuthed }}</td>
                                    <td>{{ logrow.phase }}</td>
                                    <td>{{ logrow.loginTime }}</td>
                                    <td>{{ logrow.lastClickTime }}</td>
                                    <td> <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                                        data-bs-content="<pre>{{ logrow.location }}</pre>">?</span></td>
                                    <td>
                                    <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
                                        data-bs-content="<pre>{{ logrow.loginFlowTrace }}</pre>">?</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card itil-footer" style="margin-top:10px;">
        <div class="form-buttons col-lg d-flex ms-auto ms-lg-0 flex-row-reverse p-1 ">
            <div class="m-1">
                <button class="btn btn-primary " type="submit" name="update" title="Save">
                    <i class="far fa-save"></i>
                    <span class="d-none d-xl-block">{{ __("Save") }}</span>
                    </button>
            </div>
            <div class="m-1">
                <button class="btn btn-ghost-danger" type="submit" name="delete" title="" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-original-title="Put in trashbin">
                    <i class="ti ti-trash"></i>
                    <span class="d-none d-xl-block">{{ __("Delete") }}</span>
                    </button>
            </div>
            {% if inputfields.debug.value == true %}
            <div class="m-1 align-middle text-muted pull-left pt-2">
                <a href="{{ LatestVersion.gitUrl }}" target="_blank">Repo version: {{ LatestVersion.gitVersion }} your version: v{{ LatestVersion.currentVersion }}</a> ‚ö†Ô∏è Warning SP metadata exposed! - ROWID: {{ inputfields.id.value }} | CREATED DATE: {{ inputfields.date_creation.value }} | LAST UPDATED: {{ inputfields.date_mod.value }}
            {% endif %}
        </div>
    </div>
</div>
{{ close_form|raw }}
